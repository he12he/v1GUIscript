local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- =======================
-- SETTINGS
-- =======================
local correctKey = "1234"
local flySpeed = 50
local flying = false
local bv, bg
local dragging = false
local minSpeed, maxSpeed = 10, 150

-- Aimbot Settings
local aimbotEnabled = false
local fovValue = 100
local minFov, maxFov = 10, 200

-- =======================
-- DRAG FUNCTION
-- =======================
local function makeDraggable(frame, dragHandle)
	local draggingLocal = false
	local dragStart, startPos

	dragHandle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 
			or input.UserInputType == Enum.UserInputType.Touch then
			draggingLocal = true
			dragStart = input.Position
			startPos = frame.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					draggingLocal = false
				end
			end)
		end
	end)

	dragHandle.InputChanged:Connect(function(input)
		if draggingLocal and (input.UserInputType == Enum.UserInputType.MouseMovement 
			or input.UserInputType == Enum.UserInputType.Touch) then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
end

-- =======================
-- GUI Setup
-- =======================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "KeyFlySystem"
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- Key Frame
local keyFrame = Instance.new("Frame")
keyFrame.Size = UDim2.new(0, 300, 0, 150)
keyFrame.AnchorPoint = Vector2.new(0.5, 0.5)
keyFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
keyFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
keyFrame.Parent = screenGui
Instance.new("UICorner", keyFrame).CornerRadius = UDim.new(0, 15)

local keyTitle = Instance.new("TextLabel")
keyTitle.Size = UDim2.new(1, 0, 0, 50)
keyTitle.BackgroundTransparency = 1
keyTitle.Text = "Please enter the key!"
keyTitle.Font = Enum.Font.SourceSansBold
keyTitle.TextSize = 22
keyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
keyTitle.Parent = keyFrame

local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(0.8, 0, 0, 40)
textBox.Position = UDim2.new(0.1, 0, 0.5, -20)
textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
textBox.Text = ""
textBox.PlaceholderText = "Key"
textBox.TextScaled = true
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.Parent = keyFrame
Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, 8)

makeDraggable(keyFrame, keyTitle)

-- Main Menu Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 400, 0, 250)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainFrame.Visible = false
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)

-- Kategorie-Leiste links
local categoryFrame = Instance.new("Frame")
categoryFrame.Size = UDim2.new(0, 100, 1, 0)
categoryFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
categoryFrame.Parent = mainFrame
Instance.new("UICorner", categoryFrame).CornerRadius = UDim.new(0, 10)

-- Inhalt rechts
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, -100, 1, 0)
contentFrame.Position = UDim2.new(0, 100, 0, 35) -- unter die TopBar
contentFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
contentFrame.Parent = mainFrame
Instance.new("UICorner", contentFrame).CornerRadius = UDim.new(0, 10)

makeDraggable(mainFrame, categoryFrame)

-- =======================
-- TOP BAR MIT BUTTONS
-- =======================
local topBar = Instance.new("Frame")
topBar.Size = UDim2.new(1, 0, 0, 35)
topBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
topBar.Parent = mainFrame
Instance.new("UICorner", topBar).CornerRadius = UDim.new(0, 10)

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -105, 1, 0)
titleLabel.Position = UDim2.new(0, 5, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "V1 Fly Gui"
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextSize = 20
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = topBar

-- Buttons
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 35, 0, 35)
closeButton.Position = UDim2.new(1, -35, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.TextSize = 20
closeButton.Parent = topBar
Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 8)

local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 35, 0, 35)
minimizeButton.Position = UDim2.new(1, -70, 0, 0)
minimizeButton.Text = "-"
minimizeButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.Font = Enum.Font.SourceSansBold
minimizeButton.TextSize = 20
minimizeButton.Parent = topBar
Instance.new("UICorner", minimizeButton).CornerRadius = UDim.new(0, 8)

local smallButton = Instance.new("TextButton")
smallButton.Size = UDim2.new(0, 35, 0, 35)
smallButton.Position = UDim2.new(1, -105, 0, 0)
smallButton.Text = "▢"
smallButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
smallButton.TextColor3 = Color3.fromRGB(255, 255, 255)
smallButton.Font = Enum.Font.SourceSansBold
smallButton.TextSize = 20
smallButton.Parent = topBar
Instance.new("UICorner", smallButton).CornerRadius = UDim.new(0, 8)

-- Reopen Icon
local reopenIcon = Instance.new("TextButton")
reopenIcon.Size = UDim2.new(0, 60, 0, 60)
reopenIcon.Position = UDim2.new(0, 20, 1, -80)
reopenIcon.BackgroundColor3 = Color3.fromRGB(50, 50, 200)
reopenIcon.Text = "GUI"
reopenIcon.TextColor3 = Color3.fromRGB(255, 255, 255)
reopenIcon.Font = Enum.Font.SourceSansBold
reopenIcon.TextSize = 18
reopenIcon.Parent = screenGui
reopenIcon.Visible = false
Instance.new("UICorner", reopenIcon).CornerRadius = UDim.new(1, 0)

-- =======================
-- FLY TAB
-- =======================
-- (Dein Fly-Code bleibt hier wie gehabt, ich kürze wegen Platz)

-- =======================
-- TROLL TAB
-- =======================
-- (Respawn-Button bleibt wie gehabt)

-- =======================
-- AIMBOT TAB
-- =======================
local aimbotContent = Instance.new("Frame")
aimbotContent.Size = UDim2.new(1, 0, 1, 0)
aimbotContent.BackgroundTransparency = 1
aimbotContent.Visible = false
aimbotContent.Parent = contentFrame

if UIS.TouchEnabled then
	local notAvail = Instance.new("TextLabel")
	notAvail.Size = UDim2.new(1, 0, 1, 0)
	notAvail.BackgroundTransparency = 1
	notAvail.Text = "not available for mobile device"
	notAvail.TextColor3 = Color3.fromRGB(255, 50, 50)
	notAvail.Font = Enum.Font.SourceSansBold
	notAvail.TextSize = 24
	notAvail.Parent = aimbotContent
else
	local aimToggle = Instance.new("TextButton")
	aimToggle.Size = UDim2.new(0.5, -10, 0, 40)
	aimToggle.Position = UDim2.new(0.05, 0, 0.1, 0)
	aimToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
	aimToggle.Text = "Aimbot: OFF"
	aimToggle.Font = Enum.Font.SourceSansBold
	aimToggle.TextSize = 22
	aimToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
	aimToggle.Parent = aimbotContent
	Instance.new("UICorner", aimToggle).CornerRadius = UDim.new(0, 10)

	aimToggle.MouseButton1Click:Connect(function()
		aimbotEnabled = not aimbotEnabled
		aimToggle.Text = "Aimbot: " .. (aimbotEnabled and "ON" or "OFF")
	end)

	local fovLabel = Instance.new("TextLabel")
	fovLabel.Size = UDim2.new(0.9, 0, 0, 30)
	fovLabel.Position = UDim2.new(0.05, 0, 0.35, 0)
	fovLabel.BackgroundTransparency = 1
	fovLabel.Text = "FOV: " .. fovValue
	fovLabel.Font = Enum.Font.SourceSans
	fovLabel.TextSize = 20
	fovLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	fovLabel.Parent = aimbotContent

	local fovSlider = Instance.new("Frame")
	fovSlider.Size = UDim2.new(0.9, 0, 0, 20)
	fovSlider.Position = UDim2.new(0.05, 0, 0.5, 0)
	fovSlider.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	fovSlider.Parent = aimbotContent
	Instance.new("UICorner", fovSlider).CornerRadius = UDim.new(0, 10)

	local fovKnob = Instance.new("Frame")
	fovKnob.Size = UDim2.new(0, 20, 1, 0)
	fovKnob.Position = UDim2.new((fovValue-minFov)/(maxFov-minFov), -10, 0, 0)
	fovKnob.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
	fovKnob.Parent = fovSlider
	Instance.new("UICorner", fovKnob).CornerRadius = UDim.new(1, 0)

	local draggingFov = false
	local function updateFov(xPos)
		local relative = math.clamp((xPos - fovSlider.AbsolutePosition.X) / fovSlider.AbsoluteSize.X, 0, 1)
		fovValue = math.floor(minFov + (maxFov - minFov) * relative)
		fovKnob.Position = UDim2.new(relative, -10, 0, 0)
		fovLabel.Text = "FOV: " .. fovValue
	end

	fovSlider.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			draggingFov = true
			updateFov(input.Position.X)
		end
	end)

	fovSlider.InputChanged:Connect(function(input)
		if draggingFov and input.UserInputType == Enum.UserInputType.MouseMovement then
			updateFov(input.Position.X)
		end
	end)

	UIS.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			draggingFov = false
		end
	end)
end

-- =======================
-- CATEGORY BUTTONS
-- =======================
local function createCategoryButton(name, yPos, callback)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, 0, 0, 50)
	btn.Position = UDim2.new(0, 0, 0, yPos)
	btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	btn.Text = name
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 22
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.Parent = categoryFrame
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)

	btn.MouseButton1Click:Connect(callback)
end

createCategoryButton("Fly", 35, function()
	aimbotContent.Visible = false
	flyContent.Visible = true
	trollContent.Visible = false
end)

createCategoryButton("Troll", 95, function()
	aimbotContent.Visible = false
	flyContent.Visible = false
	trollContent.Visible = true
end)

createCategoryButton("Aimbot", 155, function()
	aimbotContent.Visible = true
	flyContent.Visible = false
	trollContent.Visible = false
end)

-- =======================
-- AIMBOT LOGIC (PC only)
-- =======================
if not UIS.TouchEnabled then
	RunService.RenderStepped:Connect(function()
		if aimbotEnabled and UIS:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
			local camera = workspace.CurrentCamera
			local closestTarget, closestDist = nil, fovValue

			for _, plr in pairs(Players:GetPlayers()) do
				if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
					local head = plr.Character.Head
					local vector, onScreen = camera:WorldToViewportPoint(head.Position)
					if onScreen then
						local mousePos = UIS:GetMouseLocation()
						local dist = (Vector2.new(vector.X, vector.Y) - mousePos).Magnitude
						if dist < closestDist then
							closestDist = dist
							closestTarget = head
						end
					end
				end
			end

			if closestTarget then
				camera.CFrame = CFrame.new(camera.CFrame.Position, closestTarget.Position)
			end
		end
	end)
end

-- =======================
-- KEY CHECK
-- =======================
textBox.FocusLost:Connect(function(enterPressed)
	if enterPressed and textBox.Text == correctKey then
		keyFrame.Visible = false
		mainFrame.Visible = true
	end
end)
